name: Build Kernel Poco F6
on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: 'Kernel Source URL'
        required: true
        default: 'https://github.com/MiCode/Xiaomi_Kernel_OpenSource'
      kernel_branch:
        description: 'Kernel Branch (check if peridot-v-oss exists)'
        required: true
        default: 'peridot-u-oss'
      config_file:
        description: 'Defconfig Name'
        required: true
        default: 'peridot_defconfig'
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4
    - name: Cleanup Environment
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python2 python3 gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi
    - name: Get Clang
      run: |
        mkdir -p clang
        # Using a popular prebuilt clang (Neutron) as an example, or standard Google clang
        # For simplicity, let's use a known stable AOSP clang or similar.
        # Here we use a generic fetch script or direct download.
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
    - name: Get Kernel Source
      run: |
        git clone --depth=1 ${{ github.event.inputs.kernel_source }} -b ${{ github.event.inputs.kernel_branch }} kernel_workspace
    - name: Setup KernelSU Next (Manual Hook)
      working-directory: kernel_workspace
      run: |
        echo "Setting up KernelSU Next..."
        curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
        
        echo "Applying Manual Hook Patch..."
        # Download min_scope_syscall_hooks_v1.4.patch
        cd ..
        wget https://raw.githubusercontent.com/KernelSU-Next/kernel_patches/main/syscall_hook/min_scope_syscall_hooks_v1.4.patch
        cd kernel_workspace
        
        # Apply patch (ignore potential whitespace errors)
        # Note: If this fails, the build will fail. This is risky but standard for manual hook.
        git apply --ignore-space-change --ignore-whitespace ../min_scope_syscall_hooks_v1.4.patch || echo "Patch application had issues, checking if critical..."
        echo "Configuring Kernel for Manual Hook..."
        # Enable KSU, Enable Manual Hook, Disable Kprobes Hook
        echo "CONFIG_KSU=y" >> arch/arm64/configs/${{ github.event.inputs.config_file }}
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/${{ github.event.inputs.config_file }}
        echo "CONFIG_KSU_KPROBES_HOOK=n" >> arch/arm64/configs/${{ github.event.inputs.config_file }}
    - name: Setup SUFS (Experimental)
      working-directory: kernel_workspace
      run: |
        echo "Downloading SUFS patches..."
        git clone https://gitlab.com/simonpunk/susfs4ksu.git
        
        # NOTE: SUFS patching is complex and varies by kernel version.
        # This is a best-effort automated attempt. You may need to manually adjust paths.
        
        # Copying susfs files to kernel source
        # cp -r susfs4ksu/kernel_patches/fs/* fs/
        # cp -r susfs4ksu/kernel_patches/include/* include/
        
        # YOU MUST MANUALLY APPLY PATCHES HERE OR UNCOMMENT THE ABOVE IF PATHS MATCH
        # For now we just list what's downloaded so you can debug
        ls -R susfs4ksu
    - name: Build Kernel
      working-directory: kernel_workspace
      run: |
        export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        export CC=clang
        
        make O=out ${{ github.event.inputs.config_file }}
        
        # Adjust -j$(nproc) as needed
        make -j$(nproc --all) O=out \
                      CC=clang \
                      CROSS_COMPILE=aarch64-linux-gnu- \
                      CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
                      LD=ld.lld \
                      AR=llvm-ar \
                      NM=llvm-nm \
                      OBJCOPY=llvm-objcopy \
                      OBJDUMP=llvm-objdump \
                      STRIP=llvm-strip
    - name: Upload Image
      uses: actions/upload-artifact@v4
      with:
        name: Image
        path: kernel_workspace/out/arch/arm64/boot/Image
